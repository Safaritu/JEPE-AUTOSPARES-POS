<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JEPE POS | CASHIER TERMINAL</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #4f46e5; --primary-dark: #3730a3; --bg: #f1f5f9; 
            --card-bg: #ffffff; --danger: #e11d48; --success: #10b981; 
            --warning: #f59e0b; --text-main: #1e293b; --text-dim: #64748b;
            --border: #e2e8f0; --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --deep-blue: #0f172a;
        }

        body.dark-mode {
            --bg: #0f172a; --card-bg: #1e293b; --text-main: #f1f5f9;
            --text-dim: #94a3b8; --border: #334155;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg); padding: 10px; margin: 0; color: var(--text-main); overflow-x: hidden; width: 100%; transition: 0.3s; }
        .container { max-width: 1450px; margin: auto; width: 100%; }
        
        header { 
            display: flex; flex-direction: row; justify-content: space-between; align-items: center;
            margin-bottom: 25px; padding: 20px; background: var(--card-bg); border-radius: 16px;
            box-shadow: var(--shadow); border: 1px solid var(--border);
        }

        .logo { font-size: 1.4rem; font-weight: 800; color: var(--text-main); }
        .logo span { color: var(--primary); font-size: 0.9rem; margin-left: 5px; opacity: 0.8; }

        /* Updated Float Cards */
        .float-status-card {
            background: var(--card-bg); padding: 20px; border-radius: 16px; border: 1px solid var(--border);
            margin-bottom: 25px; display: grid; grid-template-columns: repeat(2, 1fr);
            gap: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.02);
        }
        @media (min-width: 768px) { .float-status-card { grid-template-columns: repeat(5, 1fr); } }
        .float-item label { display: block; font-size: 0.65rem; color: var(--text-dim); text-transform: uppercase; font-weight: 800; }
        .float-item span { font-size: 1.1rem; font-weight: 800; color: var(--primary); }

        .card { background: var(--card-bg); border-radius: 20px; border: 1px solid var(--border); padding: 20px; margin-bottom: 20px; box-shadow: var(--shadow); }
        .section-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.12em; color: var(--primary); margin-bottom: 20px; font-weight: 800; display: flex; align-items: center; gap: 10px; }
        .section-label::after { content: ""; flex: 1; height: 1px; background: var(--border); }

        /* FORM & INPUTS */
        .grid-inputs { display: grid; gap: 15px; }
        input, select { background: #f8fafc; border: 1px solid var(--border); padding: 14px; border-radius: 12px; font-size: 16px; color: #1e293b; width: 100%; }
        .hint-badge { padding: 4px 10px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; margin-top: 5px; }
        .bg-stock { background: #dcfce7; color: #166534; }
        .bg-min { background: #fef9c3; color: #854d0e; }

        /* MENU OVERLAY & CARDS */
        .menu-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.98); z-index: 6000; display: none; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(10px); padding: 20px; }
        .menu-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; width: 100%; max-width: 500px; }
        .menu-item { 
            background: rgba(255,255,255,0.08); padding: 22px 15px; border-radius: 18px; color: white; 
            text-decoration: none; text-align: center; font-weight: 700; font-size: 0.85rem; 
            display: flex; flex-direction: column; gap: 10px; border: 1px solid rgba(255,255,255,0.1);
        }
        .menu-item:active { background: var(--primary); transform: scale(0.95); }
        
        /* TABLE STYLES */
        .table-card { background: var(--card-bg); border-radius: 16px; border: 1px solid var(--border); overflow-x: auto; width: 100%; }
        table { width: 100%; border-collapse: collapse; }
        th { padding: 15px; background: #f8fafc; font-size: 0.7rem; color: var(--text-dim); text-align: left; border-bottom: 2px solid var(--border); }
        td { padding: 14px; border-bottom: 1px solid var(--border); font-size: 0.85rem; }

        /* BUTTONS */
        .btn { padding: 16px; border-radius: 12px; font-weight: 800; cursor: pointer; border: none; display: flex; align-items: center; justify-content: center; gap: 8px; text-transform: uppercase; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        
        .menu-fab { position: fixed; bottom: 25px; right: 25px; width: 65px; height: 65px; background: var(--deep-blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; z-index: 5000; border: 3px solid white; box-shadow: var(--shadow); }
        .low-stock-alert { color: #ff4d4d !important; font-weight: 800; animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(4px); }
        .modal { background: var(--card-bg); padding: 25px; border-radius: 24px; width: 90%; max-width: 450px; }
    </style>
</head>
<body>

<div class="menu-fab" onclick="toggleFullMenu()">‚ò∞</div>

<div class="menu-overlay" id="full-menu">
    <div style="position:absolute; top:25px; right:25px; color:white; font-size:2rem;" onclick="toggleFullMenu()">‚úï</div>
    <h2 style="color:white; margin-bottom: 25px;">Terminal Menu</h2>
    <div class="menu-grid">
        <a href="cashier.html" class="menu-item">üìä Dashboard</a>
        <a href="cashiergashub.html" class="menu-item">‚õΩ Gas Hub</a>
        <a href="pos.html" class="menu-item">üîç Search Stock</a>
        <a href="low-stock-cashier.html" class="menu-item">‚ö†Ô∏è Low Stock</a>
        <a href="debtors.html" class="menu-item">üë• Debtors</a>
        <a href="supplierscashier.html" class="menu-item">ü§ù Suppliers</a>
        <a href="cashier_inventory.html" class="menu-item">üõí Add Items</a>
        <a href="moneyinout.html" class="menu-item">üí∏ Money In/Out</a>
        <a href="shift_history_cashier.html" class="menu-item">‚è≥ Shift History</a>
        <a href="sales_reports.html" class="menu-item">üìà Sales Report</a>
        <a href="gas_delivery.html" class="menu-item">üèç Gas Delivery</a>
        <a href="cashier_report.html" class="menu-item">üìù Daily Report</a>
        <a href="sale_edit_cashier.html" class="menu-item">üìù Edit Sales</a>
        <a href="#" onclick="openSettings()" class="menu-item" style="background: var(--warning); color: #000;">‚öôÔ∏è Settings</a>
        <a href="#" onclick="logoutUser()" class="menu-item" style="background: var(--danger); grid-column: span 2;">üö™ Logout</a>
    </div>
</div>

<div id="settings-modal" class="overlay">
    <div class="modal">
        <div class="section-label">Terminal Settings</div>
        <div style="display:flex; flex-direction:column; gap:15px;">
            <button class="btn" onclick="toggleDarkMode()" style="background:#e2e8f0; color:#1e293b;">üåì Toggle Dark Mode</button>
            <button class="btn" onclick="fetchInventory()" style="background:#dcfce7; color:#166534;">üîÑ Force Stock Sync</button>
            <div style="padding:15px; background:#f8fafc; border-radius:12px; font-size:0.8rem; border:1px solid var(--border);">
                <b>Connection:</b> <span id="conn-status" style="color:var(--success)">‚óè Online</span><br>
                <b>App Version:</b> 2.4.0-Stable
            </div>
        </div>
        <button class="btn btn-danger" style="width:100%; margin-top:20px;" onclick="closeSettings()">CLOSE</button>
    </div>
</div>

<div class="container">
    <header>
        <div class="logo">JEPE POS <span>/ Cashier</span></div>
        <div id="shift-action-container"></div>
    </header>

    <div class="float-status-card">
        <div class="float-item"><label>Cash</label><span id="float-cash">0</span></div>
        <div class="float-item"><label>Mpesa</label><span id="float-mpesa">0</span></div>
        <div class="float-item"><label>KCB Float</label><span id="float-kcb">0</span></div>
        <div class="float-item"><label>Equity Float</label><span id="float-equity">0</span></div>
        <div class="float-item" style="border:1px solid var(--primary); border-radius:10px; background:#f5f3ff; padding:5px;"><label>Paybill</label><span id="live-kcb-box">0</span></div>
    </div>

    <div class="card">
        <div class="section-label">Record Sale</div>
        <form id="sale-form">
            <div class="grid-inputs" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
                <div class="input-group">
                    <label>Find Product</label>
                    <input type="text" id="pSearch" list="pList" placeholder="Name or Scan..." required autocomplete="off">
                    <datalist id="pList"></datalist>
                    <div style="display:flex; gap:5px;">
                        <span id="hint-stock" class="hint-badge bg-stock" style="display:none"></span>
                        <span id="hint-min" class="hint-badge bg-min" style="display:none"></span>
                    </div>
                </div>
                <div class="input-group"><label>Price (Ksh)</label><input type="number" id="pPrice" step="0.01" required></div>
                <div class="input-group"><label>Quantity</label><input type="number" id="pQty" value="1" min="1"></div>
                <div class="input-group">
                    <label>Payment</label>
                    <select id="pMethod" onchange="toggleSplitFields()">
                        <option value="Cash">Cash</option>
                        <option value="KCB Paybill">KCB Paybill</option>
                        <option value="Mpesa">Mpesa</option>
                        <option value="Split">Split</option>
                        <option value="Debt">Debt</option>
                    </select>
                </div>
            </div>

            <div id="split-fields" style="display: none; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; padding: 15px; background: #f8fafc; border-radius: 12px; border: 1px dashed var(--primary);">
                <div class="input-group"><label>Cash Amount</label><input type="number" id="split-cash" value="0" oninput="calculateSplit()"></div>
                <div class="input-group"><label>Online Amount</label><input type="number" id="split-online" readonly></div>
            </div>

            <button type="submit" id="submit-sale-btn" class="btn btn-primary" style="width:100%; margin-top:20px; height:65px; font-size:1.1rem;">
                CONFIRM SALE: KSH <span id="total-text">0.00</span>
            </button>
        </form>
    </div>

    <div class="section-label">Shift Transactions</div>
    <div class="table-card" style="max-height: 400px; overflow-y: auto;">
        <table>
            <thead><tr><th>Time</th><th>Item</th><th>Qty</th><th>Total</th><th>Method</th></tr></thead>
            <tbody id="live-sales-body"></tbody>
        </table>
    </div>
</div>

<div id="open-modal" class="overlay"><div class="modal"><h3>üöÄ Open Register</h3><div class="grid-inputs"><input type="number" id="o-cash" placeholder="Cash Float"><input type="number" id="o-mpesa" placeholder="Mpesa Float"></div><button class="btn btn-primary" style="width:100%; margin-top:20px;" id="confirm-open">START SHIFT</button></div></div>
<div id="close-modal" class="overlay"><div class="modal"><h3>üîí End Shift</h3><div class="grid-inputs"><input type="number" id="c-cash" placeholder="Actual Cash"><input type="number" id="c-bank" readonly style="background:#eee"></div><button class="btn btn-danger" style="width:100%; margin-top:20px;" id="confirm-close">FINALIZE</button></div></div>

<script type="module">
    import { supabase } from './auth.js';

    let inventory = [];
    let currentShift = null;
    let selectedItem = null;
    let currentKcbSalesTotal = 0;

    // --- REALTIME: Sync Inventory Automatically ---
    const productSubscription = supabase
        .channel('inventory-sync')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'products' }, (payload) => {
            fetchInventory(); 
        })
        .subscribe();

    async function fetchInventory() {
        const { data } = await supabase.from('products').select('*');
        if (data) {
            inventory = data;
            refreshProductDatalist();
            if (selectedItem) {
                const updated = inventory.find(p => p.id === selectedItem.id);
                if (updated) {
                    selectedItem = updated;
                    updateStockDisplay(updated);
                }
            }
        }
    }

    function refreshProductDatalist() {
        document.getElementById('pList').innerHTML = inventory.map(p => `<option value="${formatItemName(p)}">`).join('');
    }

    function formatItemName(p) {
        let name = p.name;
        if (p.category === 'Gas' && p.weight_category) name += ` (${p.weight_category})`;
        if (p.part_type && p.part_type !== 'N/A') name += ` [${p.part_type}]`;
        return name;
    }

    function updateStockDisplay(item) {
        const hStock = document.getElementById('hint-stock');
        hStock.innerText = `Stock: ${item.stock_quantity}`;
        hStock.style.display = 'inline-block';
        if (item.stock_quantity < 5) hStock.classList.add('low-stock-alert');
        else hStock.classList.remove('low-stock-alert');
    }

    document.getElementById('pSearch').oninput = (e) => {
        selectedItem = inventory.find(p => formatItemName(p) === e.target.value);
        if (selectedItem) {
            document.getElementById('pPrice').value = selectedItem.selling_price;
            document.getElementById('hint-min').innerText = `Min: ${selectedItem.min_price || 0}`;
            document.getElementById('hint-min').style.display = 'inline-block';
            updateStockDisplay(selectedItem);
            updateTotal();
        }
    };

    function updateTotal() {
        const price = parseFloat(document.getElementById('pPrice').value || 0);
        const qty = parseInt(document.getElementById('pQty').value || 0);
        document.getElementById('total-text').innerText = (price * qty).toLocaleString();
    }

    document.getElementById('pPrice').oninput = updateTotal;
    document.getElementById('pQty').oninput = updateTotal;

    // --- SUBMIT SALE & UPDATE DB ---
    document.getElementById('sale-form').onsubmit = async (e) => {
        e.preventDefault();
        const btn = document.getElementById('submit-sale-btn');
        if (!currentShift) return alert("Shift not open!");
        if (!selectedItem) return alert("Select product!");

        const qty = parseInt(document.getElementById('pQty').value);
        const total = parseFloat(document.getElementById('pPrice').value) * qty;
        
        btn.disabled = true;
        btn.innerText = "UPDATING SYSTEM...";

        // 1. Record Sale
        const { data: sData, error: sErr } = await supabase.from('sales').insert([{
            shift_id: currentShift.id,
            product_id: selectedItem.id,
            item_name: formatItemName(selectedItem),
            quantity: qty,
            total_amount: total,
            payment_method: document.getElementById('pMethod').value
        }]).select();

        if (!sErr) {
            // 2. IMMEDIATE INVENTORY UPDATE
            const newStock = selectedItem.stock_quantity - qty;
            const { error: invErr } = await supabase.from('products').update({ stock_quantity: newStock }).eq('id', selectedItem.id);
            
            if(!invErr) {
                alert("Sale Recorded & Stock Updated!");
                document.getElementById('sale-form').reset();
                await fetchInventory();
                await loadShiftData();
            }
        }
        btn.disabled = false;
        btn.innerText = "CONFIRM SALE";
    };

    async function loadShiftData() {
        const { data: sales } = await supabase.from('sales').select('*').eq('shift_id', currentShift.id).order('created_at', {ascending:false});
        document.getElementById('live-sales-body').innerHTML = (sales || []).map(s => `<tr><td>${new Date(s.created_at).toLocaleTimeString()}</td><td>${s.item_name}</td><td>${s.quantity}</td><td>${s.total_amount}</td><td>${s.payment_method}</td></tr>`).join('');
        
        currentKcbSalesTotal = (sales || []).filter(s => s.payment_method === 'KCB Paybill').reduce((a,b) => a + b.total_amount, 0);
        document.getElementById('live-kcb-box').innerText = currentKcbSalesTotal.toLocaleString();
    }

    async function init() {
        const { data: shift } = await supabase.from('daily_shifts').select('*').eq('status', 'Open').maybeSingle();
        if (shift) {
            currentShift = shift;
            document.getElementById('shift-action-container').innerHTML = `<button class="btn btn-danger" onclick="document.getElementById('close-modal').style.display='flex'">üî¥ CLOSE</button>`;
            await loadShiftData();
        } else {
            document.getElementById('shift-action-container').innerHTML = `<button class="btn btn-primary" onclick="document.getElementById('open-modal').style.display='flex'">üü¢ OPEN</button>`;
        }
        await fetchInventory();
    }

    // Settings Functions
    window.toggleFullMenu = () => { document.getElementById('full-menu').style.display = (document.getElementById('full-menu').style.display === 'flex') ? 'none' : 'flex'; };
    window.openSettings = () => { document.getElementById('settings-modal').style.display = 'flex'; toggleFullMenu(); };
    window.closeSettings = () => { document.getElementById('settings-modal').style.display = 'none'; };
    window.toggleDarkMode = () => { document.body.classList.toggle('dark-mode'); };
    window.logoutUser = async () => { await supabase.auth.signOut(); location.href = 'index.html'; };
    window.toggleSplitFields = () => { document.getElementById('split-fields').style.display = (document.getElementById('pMethod').value === 'Split') ? 'grid' : 'none'; };

    init();
</script>
</body>
</html>
