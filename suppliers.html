<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Suppliers & Logistics | JEPE ADMIN</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --admin-dark: #1e293b;
            --admin-accent: #6366f1;
            --bg: #f8fafc;
            --white: #ffffff;
            --text: #1e293b;
            --text-dim: #64748b;
            --border: #e2e8f0;
            --success: #10b981;
            --danger: #ef4444;
            --orange: #f59e0b;
            --sidebar-width: 260px;
            --sidebar-bg: #0f172a; 
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: var(--bg); margin: 0; color: var(--text);
            display: flex; min-height: 100vh;
        }

        /* --- SIDEBAR --- */
        .sidebar { 
            width: var(--sidebar-width); background: var(--sidebar-bg); position: fixed; 
            left: 0; top: 0; height: 100vh; z-index: 3000; overflow-y: auto; 
            transition: transform 0.3s ease; display: flex; flex-direction: column;
        }
        .sidebar-header { 
            padding: 25px; font-weight: 800; color: white; 
            border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 1.2rem; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .close-menu { display: none; background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; }
        
        .nav-list { padding: 15px; list-style: none; margin: 0; flex-grow: 1; }
        .nav-link { 
            display: flex; align-items: center; padding: 12px 15px; 
            text-decoration: none; color: #94a3b8; font-weight: 600; 
            border-radius: 10px; margin-bottom: 4px; transition: 0.2s; font-size: 0.9rem; 
        }
        .nav-link span:first-child { margin-right: 12px; font-size: 1.1rem; }
        .nav-link:hover { background: rgba(255,255,255,0.05); color: white; }
        .nav-link.active { background: var(--admin-accent); color: white; }

        /* --- MENU TRIGGER --- */
        .menu-trigger {
            display: none; position: fixed; top: 15px; left: 15px; z-index: 2500;
            background: var(--sidebar-bg); color: white; border: none; padding: 10px 15px;
            border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 700;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* --- MAIN CONTENT --- */
        .main-wrapper { flex-grow: 1; width: 100%; margin-left: var(--sidebar-width); position: relative; }
        
        @media (max-width: 1024px) { 
            .sidebar { transform: translateX(-100%); }
            .sidebar.active { transform: translateX(0); }
            .main-wrapper { margin-left: 0; padding-top: 60px; }
            .menu-trigger { display: block; }
            .close-menu { display: block; }
        }

        .container { padding: 25px; max-width: 1200px; margin: auto; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-card { 
            background: var(--white); padding: 20px; border-radius: 16px; 
            border: 1px solid var(--border); box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            border-left: 5px solid var(--admin-accent);
        }
        .stat-card h4 { margin: 0; color: var(--text-dim); font-size: 0.65rem; text-transform: uppercase; letter-spacing: 1px; font-weight: 800; }
        .stat-card p { margin: 8px 0 0; font-size: 1.4rem; font-weight: 800; }

        .card { background: var(--white); border-radius: 20px; border: 1px solid var(--border); padding: 24px; margin-bottom: 25px; }
        .table-container { width: 100%; overflow-x: auto; border-radius: 12px; border: 1px solid #f1f5f9; }
        table { width: 100%; border-collapse: collapse; min-width: 750px; }
        th { text-align: left; padding: 14px; background: #f8fafc; font-size: 0.7rem; text-transform: uppercase; color: var(--text-dim); font-weight: 800; }
        td { padding: 14px; border-bottom: 1px solid #f1f5f9; font-size: 0.85rem; }

        .btn { padding: 10px 18px; border-radius: 10px; font-weight: 700; cursor: pointer; border: none; font-size: 0.75rem; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-add { background: var(--admin-accent); color: white; }
        .btn-pay { background: var(--orange); color: white; }
        .btn-order { background: var(--admin-dark); color: white; }
        .btn-load { width: 100%; background: #f1f5f9; color: var(--text-dim); margin-top: 10px; }
        
        .badge { padding: 4px 10px; border-radius: 6px; font-weight: 800; font-size: 0.7rem; }
        .bg-debt { background: #fee2e2; color: #991b1b; }
        .bg-clear { background: #dcfce7; color: #166534; }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); justify-content: center; align-items: center; z-index: 4000; padding: 20px; }
        .modal-content { background: white; padding: 25px; border-radius: 24px; width: 100%; max-width: 480px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); overflow-y: auto; max-height: 90vh; }
        .modal label { font-size: 0.65rem; font-weight: 800; color: var(--text-dim); display: block; margin-top: 12px; margin-bottom: 4px; text-transform: uppercase; }
        .modal input, .modal select { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 10px; font-family: inherit; font-size: 0.95rem; outline: none; }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin: 30px 0 15px; }
        .section-header h3 { margin: 0; font-weight: 800; font-size: 1.1rem; }
    </style>
</head>
<body>

<button class="menu-trigger" onclick="toggleMenu()">‚ò∞ MENU</button>

<nav class="sidebar" id="sidebar">
    <div class="sidebar-header">
        JEPE ADMIN
        <button class="close-menu" onclick="toggleMenu()">√ó</button>
    </div>
    <div class="nav-list">
        <a href="admin.html" class="nav-link"><span>üìä</span> <span>Dashboard</span></a>
        <a href="gas_hub.html" class="nav-link"><span>üî•</span> <span>Gas Hub</span></a>
        <a href="spares_hub.html" class="nav-link"><span>‚öôÔ∏è</span> <span>Spare Parts Hub</span></a>
        <a href="motorbike_hub.html" class="nav-link"><span>üèçÔ∏è</span> <span>Motorbike Hub</span></a>
        <a href="tuktuk_hub.html" class="nav-link"> <span>üöñ</span><span>TUKTUK Hub</span></a>

        <a href="shift-history.html" class="nav-link"><span>üìã</span> <span>Daily Shifts</span></a>
        <a href="money-history.html" class="nav-link"><span>üí∞</span> <span>Money IN/OUT</span></a>
        <a href="sales-history.html" class="nav-link"><span>üìú</span> <span>Sales History</span></a>

        <a href="inventory.html" class="nav-link"><span>‚ûï</span> <span>Add Stock</span></a>
        <a href="sales_editor.html" class="nav-link"><span>‚úèÔ∏è</span> <span>Edit Stock</span></a>
        <a href="admin-debtors.html" class="nav-link"><span>üë•</span> <span>Debtors</span></a>
        <a href="low_stock.html" class="nav-link"><span>‚ö†Ô∏è</span> <span>Low Stock</span></a>
        <a href="audit_trail.html" class="nav-link"><span>üîç</span> <span>Inventory Track</span></a>

        <a href="reports.html" class="nav-link"><span>üìÑ</span> <span>Reports</span></a>
        <a href="price_audits.html" class="nav-link"><span>üìâ</span> <span>Underpriced</span></a>
        <a href="suppliers.html" class="nav-link active"><span>ü§ù</span> <span>Suppliers</span></a>
        <a href="admin.html" class="nav-link"><span>üè†</span> <span>HOME</span></a>
    </div>
    <div style="padding: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
        <a onclick="handleLogout()" class="nav-link" style="color: #fb7185; cursor:pointer;">üö™ Logout</a>
    </div>
</nav>

<div class="main-wrapper">
    <div class="container">
        <div class="stats-grid">
            <div class="stat-card" style="border-left-color: var(--danger);">
                <h4>Total Payable (Debt)</h4>
                <p id="stat-total-debt" style="color: var(--danger);">Ksh 0</p>
            </div>
            <div class="stat-card" style="border-left-color: var(--admin-accent);">
                <h4>Paid (Digital Account)</h4>
                <p id="stat-digital-total">Ksh 0</p>
            </div>
            <div class="stat-card" style="border-left-color: var(--orange);">
                <h4>Paid (Shop Cash)</h4>
                <p id="stat-cash-total">Ksh 0</p>
            </div>
        </div>

        <div class="section-header">
            <h3>Supplier Directory</h3>
            <button class="btn btn-add" onclick="openSupplierModal()">+ New Supplier</button>
        </div>

        <div class="card">
            <input type="text" id="searchSupplier" style="width:100%; padding:14px; margin-bottom:20px; border-radius:12px; border:1px solid #e2e8f0;" placeholder="Search by name or category..." onkeyup="filterSuppliers()">
            <div class="table-container">
                <table id="supplierTable">
                    <thead>
                        <tr>
                            <th>Supplier Name</th>
                            <th>Category</th>
                            <th>Phone</th>
                            <th>Balance Owed</th>
                            <th>Quick Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div class="section-header"><h3>Recent Stock Deliveries</h3></div>
        <div class="card">
            <div class="table-container">
                <table id="orderTable">
                    <thead>
                        <tr><th>Date</th><th>Supplier</th><th>Items/Description</th><th>Bill Amount</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <button class="btn btn-load" onclick="loadMoreOrders()">View More Deliveries</button>
        </div>
    </div>
</div>

<div id="paymentModal" class="modal"><div class="modal-content">
    <h3 style="margin:0">Record Payment</h3>
    <input type="hidden" id="pay-sup-id">
    <label>SUPPLIER</label>
    <input type="text" id="pay-sup-name" readonly style="background:#f1f5f9; font-weight:800;">
    <label>PAYMENT SOURCE</label>
    <select id="pay-method">
        <option>Digital/Sales Account</option>
        <option>Shop Cash</option>
    </select>
    <label>AMOUNT TO PAY (KSH)</label>
    <input type="number" id="pay-amount" placeholder="0.00">
    <button class="btn btn-pay" id="confirmPaymentBtn" onclick="processPayment()" style="width:100%; padding:15px; margin-top:20px;">Confirm Payment</button>
    <button class="btn" onclick="closeModals()" style="width:100%; margin-top:10px; background:none; color:var(--text-dim);">Close</button>
</div></div>

<div id="supplierModal" class="modal"><div class="modal-content">
    <h3 style="margin:0">Supplier Details</h3>
    <input type="hidden" id="sup-id">
    <label>COMPANY/NAME</label>
    <input type="text" id="sup-name" placeholder="Enter supplier name">
    <label>BUSINESS CATEGORY</label>
    <select id="sup-category">
        <option>Spare Parts</option><option>Gas</option><option>Tyres</option><option>Oil/Lubricants</option><option>General</option>
    </select>
    <label>CONTACT PHONE</label>
    <input type="text" id="sup-phone" placeholder="07xx xxx xxx">
    <label>CURRENT BALANCE (KSH)</label>
    <input type="number" id="sup-balance" value="0">
    <button class="btn btn-add" onclick="saveSupplier()" style="width:100%; padding:15px; margin-top:20px;">Save Supplier</button>
    <button class="btn" onclick="closeModals()" style="width:100%; margin-top:10px; background:none; color:var(--text-dim);">Cancel</button>
</div></div>

<div id="orderModal" class="modal"><div class="modal-content">
    <h3 style="margin:0; color:var(--admin-accent);">üì¶ Receive Stock</h3>
    <input type="hidden" id="order-sup-id">
    <label>SUPPLIER</label>
    <input type="text" id="order-sup-name" readonly style="background:#f1f5f9; font-weight:800;">
    <label>SELECT PRODUCT</label>
    <input type="text" id="restock-search" list="productList" placeholder="Search inventory..." onchange="handleProductSelect(this.value)">
    <datalist id="productList"></datalist>
    <input type="hidden" id="selected-product-id">
    <div class="grid-2">
        <div><label>QUANTITY</label><input type="number" id="order-qty" placeholder="0" oninput="calculateOrderCost()"></div>
        <div><label>BUY PRICE</label><input type="number" id="order-buy-price" placeholder="0.00" oninput="calculateOrderCost()"></div>
    </div>
    <div class="grid-2">
        <div><label>NEW SELL PRICE</label><input type="number" id="order-sell-price" placeholder="0.00"></div>
        <div><label>MIN SELL PRICE</label><input type="number" id="order-min-price" placeholder="0.00"></div>
    </div>
    <div style="background: #f1f5f9; padding: 15px; border-radius: 12px; margin-top: 15px;">
        <label>Total Delivery Value</label>
        <h2 id="order-total-display" style="margin:0; color:var(--danger);">Ksh 0.00</h2>
    </div>
    <button class="btn btn-order" id="saveOrderBtn" onclick="saveOrder()" style="width:100%; padding:15px; margin-top:20px;">Finalize Update</button>
    <button class="btn" onclick="closeModals()" style="width:100%; margin-top:10px; background:none; color:var(--text-dim);">Cancel</button>
</div></div>

<script type="module">
    import { supabase } from './auth.js';

    let allSuppliers = [], allOrders = [], allPayments = [], allProducts = [];
    let orderLimit = 10;

    // Sidebar Toggle
    window.toggleMenu = function() {
        document.getElementById('sidebar').classList.toggle('active');
    };

    async function init() {
        await fetchSuppliers();
        await fetchOrders();
        await fetchPayments();
        await fetchProducts();
    }

    async function fetchProducts() {
        const { data } = await supabase.from('products').select('*').order('name');
        allProducts = data || [];
        document.getElementById('productList').innerHTML = allProducts.map(p => 
            `<option value="${p.name}${p.part_type !== 'N/A' ? ' ['+p.part_type+']' : ''}" data-id="${p.id}">`
        ).join('');
    }

    async function fetchSuppliers() {
        const { data } = await supabase.from('suppliers').select('*').order('name');
        if (data) {
            allSuppliers = data;
            const totalDebt = data.reduce((sum, s) => sum + (s.balance_owed || 0), 0);
            document.getElementById('stat-total-debt').innerText = `Ksh ${totalDebt.toLocaleString()}`;
            filterSuppliers();
        }
    }

    async function fetchOrders() {
        const { data } = await supabase.from('supplier_orders').select('*, suppliers(name)').order('order_date', {ascending:false});
        if (data) { allOrders = data; filterOrders(); }
    }

    async function fetchPayments() {
        const { data } = await supabase.from('supplier_payments').select('*, suppliers(name)').order('payment_date', {ascending:false});
        if (data) { 
            allPayments = data; 
            let digital = 0, cash = 0;
            data.forEach(p => { 
                if (p.payment_method === 'Digital/Sales Account') digital += p.amount_paid;
                else cash += p.amount_paid;
            });
            document.getElementById('stat-digital-total').innerText = `Ksh ${digital.toLocaleString()}`;
            document.getElementById('stat-cash-total').innerText = `Ksh ${cash.toLocaleString()}`;
        }
    }

    window.filterSuppliers = () => {
        const q = document.getElementById('searchSupplier').value.toLowerCase();
        const filtered = allSuppliers.filter(s => s.name.toLowerCase().includes(q) || s.category.toLowerCase().includes(q));
        document.querySelector('#supplierTable tbody').innerHTML = filtered.map(s => `
            <tr>
                <td><b>${s.name}</b></td>
                <td><span class="badge" style="background:#f1f5f9; color:var(--text-dim)">${s.category}</span></td>
                <td>${s.phone || '--'}</td>
                <td><span class="badge ${s.balance_owed > 0 ? 'bg-debt' : 'bg-clear'}">Ksh ${s.balance_owed.toLocaleString()}</span></td>
                <td>
                    <div style="display:flex; gap:8px;">
                        <button class="btn btn-order" onclick="openOrderModal('${s.id}', '${s.name}')">+ Stock</button>
                        <button class="btn btn-pay" onclick="openPaymentModal('${s.id}', '${s.name}')">Pay</button>
                        <button class="btn" style="background:#f1f5f9; color:var(--admin-accent)" onclick="editSupplier('${s.id}')">‚úèÔ∏èEDIT</button>
                    </div>
                </td>
            </tr>
        `).join('');
    };

    window.filterOrders = () => {
        document.querySelector('#orderTable tbody').innerHTML = allOrders.slice(0, orderLimit).map(o => `
            <tr>
                <td><small>${new Date(o.order_date).toLocaleDateString()}</small></td>
                <td><b>${o.suppliers?.name || '---'}</b></td>
                <td>${o.items_brought}</td>
                <td style="font-weight:800;">Ksh ${o.cost.toLocaleString()}</td>
            </tr>
        `).join('');
    };

    window.handleProductSelect = (val) => {
        const product = allProducts.find(p => (p.name + (p.part_type !== 'N/A' ? ' ['+p.part_type+']' : '')) === val);
        if (product) {
            document.getElementById('selected-product-id').value = product.id;
            document.getElementById('order-buy-price').value = product.cost_price || 0;
            document.getElementById('order-sell-price').value = product.selling_price || 0;
            document.getElementById('order-min-price').value = product.min_selling_price || 0;
        }
    };

    window.calculateOrderCost = () => {
        const qty = parseFloat(document.getElementById('order-qty').value) || 0;
        const buy = parseFloat(document.getElementById('order-buy-price').value) || 0;
        document.getElementById('order-total-display').innerText = `Ksh ${(qty * buy).toLocaleString()}`;
    };

    window.saveOrder = async () => {
        const saveBtn = document.getElementById('saveOrderBtn');
        const sid = document.getElementById('order-sup-id').value;
        const pid = document.getElementById('selected-product-id').value;
        const qty = parseInt(document.getElementById('order-qty').value) || 0;
        const buyPrice = parseFloat(document.getElementById('order-buy-price').value) || 0;
        const sellPrice = parseFloat(document.getElementById('order-sell-price').value) || 0;
        const minPrice = parseFloat(document.getElementById('order-min-price').value) || 0;
        const totalCost = qty * buyPrice;

        if(!pid || qty <= 0) return alert("Select product and enter valid quantity");

        saveBtn.disabled = true;
        saveBtn.innerText = "Saving...";

        await supabase.from('supplier_orders').insert([{ 
            supplier_id: sid, 
            items_brought: `${qty}x ${document.getElementById('restock-search').value}`, 
            cost: totalCost 
        }]);

        const targetProduct = allProducts.find(p => p.id === pid);
        await supabase.from('products').update({ 
            stock_quantity: (targetProduct.stock_quantity || 0) + qty,
            cost_price: buyPrice,
            selling_price: sellPrice,
            min_selling_price: minPrice,
            min_price: minPrice
        }).eq('id', pid);

        const supplier = allSuppliers.find(x => x.id === sid);
        await supabase.from('suppliers').update({ balance_owed: (supplier.balance_owed || 0) + totalCost }).eq('id', sid);

        closeModals();
        saveBtn.disabled = false;
        saveBtn.innerText = "Finalize Update";
        init();
    };

    window.openPaymentModal = (id, name) => {
        document.getElementById('pay-sup-id').value = id;
        document.getElementById('pay-sup-name').value = name;
        document.getElementById('pay-amount').value = "";
        document.getElementById('paymentModal').style.display = "flex";
    };

    window.openOrderModal = (id, name) => {
        document.getElementById('order-sup-id').value = id;
        document.getElementById('order-sup-name').value = name;
        document.getElementById('orderModal').style.display = "flex";
    };

    window.openSupplierModal = () => {
        document.getElementById('sup-id').value = "";
        document.getElementById('sup-name').value = "";
        document.getElementById('sup-balance').value = 0;
        document.getElementById('sup-phone').value = "";
        document.getElementById('supplierModal').style.display = "flex";
    };

    window.closeModals = () => document.querySelectorAll('.modal').forEach(m => m.style.display = "none");

    window.saveSupplier = async () => {
        const id = document.getElementById('sup-id').value;
        const payload = {
            name: document.getElementById('sup-name').value,
            category: document.getElementById('sup-category').value,
            phone: document.getElementById('sup-phone').value,
            balance_owed: parseFloat(document.getElementById('sup-balance').value) || 0
        };
        id ? await supabase.from('suppliers').update(payload).eq('id', id) : await supabase.from('suppliers').insert([payload]);
        closeModals(); init();
    };

    window.processPayment = async () => {
        const sid = document.getElementById('pay-sup-id').value;
        const sname = document.getElementById('pay-sup-name').value;
        const amount = parseFloat(document.getElementById('pay-amount').value);
        const method = document.getElementById('pay-method').value;
        const btn = document.getElementById('confirmPaymentBtn');

        if(!amount || amount <= 0) return alert("Enter valid amount");

        btn.disabled = true;
        btn.innerText = "Processing...";

        try {
            const { data: activeShift } = await supabase.from('daily_shifts').select('id').eq('status', 'Open').maybeSingle();
            const supplier = allSuppliers.find(x => x.id === sid);
            const newBalance = (supplier.balance_owed || 0) - amount;
            
            await supabase.from('suppliers').update({ balance_owed: newBalance }).eq('id', sid);
            await supabase.from('supplier_payments').insert([{
                supplier_id: sid, 
                amount_paid: amount, 
                balance_before: supplier.balance_owed,
                balance_after: newBalance, 
                payment_method: method
            }]);

            await supabase.from('cash_transactions').insert([{
                type: 'Money Out',
                category: 'Supplier Payment',
                amount: amount,
                description: `Paid ${sname} via ${method}`,
                shift_id: activeShift ? activeShift.id : null
            }]);

            alert(`Payment of Ksh ${amount.toLocaleString()} recorded.`);
            closeModals(); init();
        } finally {
            btn.disabled = false;
            btn.innerText = "Confirm Payment";
        }
    };

    window.editSupplier = (id) => {
        const s = allSuppliers.find(x => x.id === id);
        document.getElementById('sup-id').value = s.id;
        document.getElementById('sup-name').value = s.name;
        document.getElementById('sup-category').value = s.category;
        document.getElementById('sup-phone').value = s.phone;
        document.getElementById('sup-balance').value = s.balance_owed;
        document.getElementById('supplierModal').style.display = "flex";
    };

    window.handleLogout = async () => { await supabase.auth.signOut(); window.location.href = 'index.html'; };

    init();
</script>
</body>
</html>
