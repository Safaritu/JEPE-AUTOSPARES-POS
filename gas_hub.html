<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JEPE ADMIN | Gas Hub</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --admin-dark: #0f172a; --admin-accent: #6366f1; --bg: #f8fafc;
            --white: #ffffff; --text: #1e293b; --border: #e2e8f0; --sidebar-width: 260px;
            --sidebar-collapsed: 70px;
        }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); margin: 0; display: flex; color: var(--text); min-height: 100vh; }
        
        .sidebar { 
            width: var(--sidebar-collapsed); height: 100vh; background: var(--admin-dark); 
            color: white; padding: 20px 10px; position: fixed; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-x: hidden; z-index: 1000; box-sizing: border-box;
        }
        .sidebar:hover, .sidebar.mobile-active { width: var(--sidebar-width); }
        .sidebar h2 { font-size: 1.2rem; margin-bottom: 30px; white-space: nowrap; opacity: 0; transition: 0.3s; padding-left: 10px; }
        .sidebar:hover h2, .sidebar.mobile-active h2 { opacity: 1; }
        
        .nav-link { 
            display: flex; align-items: center; padding: 12px; color: #94a3b8; 
            text-decoration: none; border-radius: 8px; margin-bottom: 5px; transition: 0.3s;
        }
        .nav-link span:first-child { min-width: 30px; font-size: 1.2rem; text-align: center; }
        .nav-link span:last-child { opacity: 0; white-space: nowrap; transition: 0.3s; margin-left: 15px; }
        .sidebar:hover .nav-link span:last-child, .sidebar.mobile-active .nav-link span:last-child { opacity: 1; }
        .nav-link:hover, .nav-link.active { background: var(--admin-accent); color: white; }

        .menu-toggle {
            display: none; position: fixed; top: 15px; right: 15px; z-index: 1100;
            background: var(--admin-dark); color: white; border: none; padding: 10px;
            border-radius: 8px; cursor: pointer; font-size: 1.2rem;
        }

        .main-content { 
            margin-left: var(--sidebar-collapsed); padding: 30px; width: calc(100% - var(--sidebar-collapsed)); 
            transition: 0.3s; box-sizing: border-box; 
        }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .stat-card { padding: 20px; border-radius: 15px; color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .card-blue { background: #2563eb; } .card-green { background: #10b981; }
        .card-dark { background: #1e293b; } .card-orange { background: #f59e0b; }

        .valuation-bar { 
            background: white; border-radius: 15px; padding: 20px; 
            display: grid; grid-template-columns: repeat(4, 1fr); 
            border: 1px solid var(--border); margin-bottom: 30px;
        }
        .val-item { border-left: 1px solid var(--border); padding: 5px 20px; }
        .val-item:first-child { border-left: none; }
        .val-item small { color: #64748b; display: block; margin-bottom: 5px; }

        .table-container { background: white; border-radius: 15px; padding: 20px; border: 1px solid var(--border); margin-bottom: 30px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { text-align: left; color: #64748b; font-size: 0.75rem; text-transform: uppercase; padding: 12px; border-bottom: 1px solid var(--border); }
        td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 0.85rem; }
        .profit-text { color: #10b981; font-weight: 700; }

        .load-more-btn {
            display: block; width: 100%; max-width: 250px; margin: 20px auto 0; padding: 12px;
            background: #f1f5f9; border: 1px solid var(--border); border-radius: 8px;
            color: var(--admin-accent); font-weight: 700; cursor: pointer; transition: 0.3s;
        }

        .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .brand-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 20px; }
        .brand-card { background: white; border-radius: 15px; padding: 20px; border: 1px solid var(--border); }
        .stock-badge { padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; }
        .badge-full { background: #dcfce7; color: #166534; }
        .badge-empty { background: #fee2e2; color: #991b1b; }

        @media (max-width: 768px) {
            .menu-toggle { display: block; }
            .sidebar { transform: translateX(-100%); width: var(--sidebar-width); }
            .sidebar.mobile-active { transform: translateX(0); }
            .main-content { margin-left: 0; width: 100%; padding: 20px; padding-top: 70px; }
            .valuation-bar { grid-template-columns: 1fr 1fr; gap: 15px; }
            .val-item { border-left: none; padding: 0; }
            .charts-grid { grid-template-columns: 1fr; }
            canvas { max-height: 250px; }
        }
    </style>
</head>
<body>

    <button class="menu-toggle" onclick="toggleMenu()">‚ò∞</button>

    <div class="sidebar" id="sidebar">
        <h2>JEPE ADMIN</h2>
        <nav>
            <a href="admin.html" class="nav-link"><span>üìä</span> <span>Dashboard</span></a>
            <a href="inventory.html" class="nav-link"><span>‚ûï</span> <span>Add Stock</span></a>
            <a href="sales_editor.html" class="nav-link"><span>‚úèÔ∏è</span> <span>Edit Stock</span></a>
            <a href="gas_hub.html" class="nav-link active"><span>üî•</span> <span>Gas Hub</span></a>
            <a href="spares_hub.html" class="nav-link"><span>üìã</span> <span>Spare Hub</span></a>
            <a href="motorbike_hub.html" class="nav-link"><span>üèçÔ∏è</span> <span>Motorbike Hub</span></a>
            <a href="shift-history.html" class="nav-link"><span>üìã</span> <span>Daily Shifts</span></a>
            <a href="sales-history.html" class="nav-link"><span>üìú</span> <span>Sales History</span></a>
            <a href="money-history.html" class="nav-link"><span>üí∞</span> <span>Money IN/OUT</span></a>
            <a href="admin-debtors.html" class="nav-link"><span>üë•</span> <span>Debtors</span></a>
            <a href="low_stock.html" class="nav-link"><span>‚ö†Ô∏è</span> <span>Low Stock</span></a>
            <a href="audit_trail.html" class="nav-link"><span>üîç</span> <span>Inventory Track</span></a>
            <a href="reports.html" class="nav-link"><span>üìÑ</span> <span>Reports</span></a>
            <a href="price_audits.html" class="nav-link"><span>üìâ</span> <span>Underpriced</span></a>
            <a href="suppliers.html" class="nav-link"><span>ü§ù</span> <span>Suppliers</span></a>
        </nav>
    </div>

    <div class="main-content">
        <header style="margin-bottom: 25px;">
            <h1 style="margin:0; font-size: 1.5rem;">Gas Inventory Hub</h1>
            <p style="color: #64748b; font-size: 0.9rem;">Live performance and financial tracking.</p>
        </header>

        <div class="stats-grid">
            <div class="stat-card card-blue"><small>TODAYS SALES(GAS)</small><div id="shift-sales" style="font-size:1.4rem; font-weight:800;">Ksh 0</div></div>
            <div class="stat-card card-green"><small>TODAYS PROFIT(GAS)</small><div id="shift-profit" style="font-size:1.4rem; font-weight:800;">Ksh 0</div></div>
            <div class="stat-card card-dark"><small>GAS BRANDS</small><div id="total-brands" style="font-size:1.4rem; font-weight:800;">0</div></div>
            <div class="stat-card card-orange"><small>SUPPLIERS</small><div id="total-suppliers" style="font-size:1.4rem; font-weight:800;">0</div></div>
        </div>

        <div class="valuation-bar">
            <div class="val-item"><small>INV. COST</small><div id="all-inv-cost" style="font-weight:800;">Ksh 0</div></div>
            <div class="val-item"><small>EXP. PROFIT</small><div id="all-exp-profit" style="font-weight:800; color:#10b981;">Ksh 0</div></div>
            <div class="val-item"><small>TOTAL SALES SO FAR</small><div id="all-time-sales" style="font-weight:800;">Ksh 0</div></div>
            <div class="val-item"><small>TOTAL PROFIT SO FAR</small><div id="all-time-profit" style="font-weight:800; color:#2563eb;">Ksh 0</div></div>
        </div>

        <div class="table-container">
            <h3 style="margin-top:0;">üìà Brand Performance</h3>
            <table>
                <thead>
                    <tr>
                        <th>Brand & Weight</th>
                        <th>Stock</th>
                        <th>Sold</th>
                        <th>Revenue</th>
                        <th>Profit</th>
                    </tr>
                </thead>
                <tbody id="performance-table-body"></tbody>
            </table>
            <button id="loadMoreBtn" class="load-more-btn">Load More Brands</button>
        </div>

        <div class="charts-grid">
            <div class="table-container">
                <h3 style="margin-top:0;">üìä Weight Summary</h3>
                <table>
                    <thead><tr><th>Category</th><th>Full</th><th>Empty</th><th>Total</th></tr></thead>
                    <tbody id="summary-table-body"></tbody>
                </table>
            </div>
            <div class="table-container">
                <canvas id="weightChart"></canvas>
            </div>
        </div>

        <div style="margin-top: 20px;">
            <h3>üì¶ Brand Inventory </h3>
            <div id="brand-cards-container" class="brand-grid"></div>
        </div>
    </div>

    <script type="module">
        import { supabase } from './auth.js';

        let allBrandPerf = [];
        let itemsToShow = 5;

        window.toggleMenu = function() {
            document.getElementById('sidebar').classList.toggle('mobile-active');
        }

        async function init() {
            try {
                // 1. Fetch products only for Gas
                const { data: products } = await supabase.from('products').select('*').eq('category', 'Gas');
                
                // 2. Fetch the latest shift ID
                const { data: latestShift } = await supabase.from('daily_shifts').select('id').order('start_time', { ascending: false }).limit(1);
                
                // 3. Fetch ALL sales (we will filter manually to handle the NULL category issue)
                const { data: allSales } = await supabase.from('sales').select('*');
                
                const { count: supplierCount } = await supabase.from('suppliers').select('*', { count: 'exact', head: true });

                if (products) {
                    // Filter sales where either category is 'Gas' OR the product_id exists in our Gas products list
                    const gasProductIds = products.map(p => p.id);
                    const filteredGasSales = (allSales || []).filter(s => 
                        s.category === 'Gas' || gasProductIds.includes(s.product_id)
                    );

                    renderDashboard(products, filteredGasSales, latestShift?.[0]?.id, supplierCount || 0);
                }
            } catch (err) { console.error(err); }
        }

        function renderDashboard(products, sales, shiftId, supplierCount) {
            let invCost = 0, expProfit = 0, totalSales = 0, totalProfit = 0, sSales = 0, sProfit = 0;
            const brandPerfMap = {};
            const groupedInventory = {};

            // Map products
            products.forEach(p => {
                const stock = Number(p.stock_quantity) || 0;
                const empty = Number(p.empty_quantity) || 0;
                const cost = Number(p.cost_price) || 0;
                const price = Number(p.selling_price) || 0;

                invCost += (stock * cost);
                expProfit += (stock * (price - cost));
                
                brandPerfMap[p.id] = { 
                    name: p.name, 
                    weight: p.weight_category || '-', 
                    stock, 
                    sold: 0, 
                    revenue: 0, 
                    profit: 0 
                };

                const brandName = p.name.split(' ')[0].toUpperCase();
                if (!groupedInventory[brandName]) groupedInventory[brandName] = [];
                groupedInventory[brandName].push({ weight: p.weight_category, full: stock, empty: empty });
            });

            // Process filtered sales
            sales.forEach(s => {
                const qty = Number(s.quantity) || 0;
                const revenue = Number(s.total_amount) || Number(s.amount) || 0; 
                const cost = Number(s.cost_price) || 0;
                
                // If sale record cost is 0, try to find the cost from the products map
                const actualCost = cost > 0 ? cost : (products.find(p => p.id === s.product_id)?.cost_price || 0);
                const profit = revenue - (actualCost * qty);

                totalSales += revenue;
                totalProfit += profit;

                if (brandPerfMap[s.product_id]) {
                    brandPerfMap[s.product_id].sold += qty;
                    brandPerfMap[s.product_id].revenue += revenue;
                    brandPerfMap[s.product_id].profit += profit;
                }

                if (shiftId && s.shift_id === shiftId) {
                    sSales += revenue; 
                    sProfit += profit;
                }
            });

            // Update UI
            document.getElementById('shift-sales').innerText = `Ksh ${sSales.toLocaleString()}`;
            document.getElementById('shift-profit').innerText = `Ksh ${sProfit.toLocaleString()}`;
            document.getElementById('all-inv-cost').innerText = `Ksh ${invCost.toLocaleString()}`;
            document.getElementById('all-exp-profit').innerText = `Ksh ${expProfit.toLocaleString()}`;
            document.getElementById('all-time-sales').innerText = `Ksh ${totalSales.toLocaleString()}`;
            document.getElementById('all-time-profit').innerText = `Ksh ${totalProfit.toLocaleString()}`;
            document.getElementById('total-brands').innerText = products.length;
            document.getElementById('total-suppliers').innerText = supplierCount;

            allBrandPerf = Object.values(brandPerfMap).sort((a, b) => b.revenue - a.revenue);
            updateTable();

            // Render Brand Cards
            document.getElementById('brand-cards-container').innerHTML = Object.entries(groupedInventory).map(([brand, weights]) => `
                <div class="brand-card">
                    <h4 style="margin:0 0 10px 0;">${brand}</h4>
                    ${weights.map(w => `
                        <div style="display:flex; justify-content:space-between; margin-bottom:8px; border-bottom:1px solid #f1f5f9; padding-bottom:5px;">
                            <span><strong>${w.weight}</strong></span>
                            <div>
                                <span class="stock-badge badge-full">F: ${w.full}</span>
                                <span class="stock-badge badge-empty">E: ${w.empty}</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `).join('');

            renderSummary(products);
        }

        function updateTable() {
            const tableBody = document.getElementById('performance-table-body');
            tableBody.innerHTML = allBrandPerf.slice(0, itemsToShow).map(b => `
                <tr>
                    <td><strong>${b.name}</strong></td>
                    <td>${b.stock}</td>
                    <td>${b.sold}</td>
                    <td>Ksh ${b.revenue.toLocaleString()}</td>
                    <td class="profit-text">Ksh ${b.profit.toLocaleString()}</td>
                </tr>
            `).join('');
            document.getElementById('loadMoreBtn').style.display = itemsToShow >= allBrandPerf.length ? 'none' : 'block';
        }

        document.getElementById('loadMoreBtn').addEventListener('click', () => {
            itemsToShow += 5; updateTable();
        });

        function renderSummary(products) {
            const weights = ['6kg', '13kg', '50kg'];
            const summary = weights.map(w => {
                const items = products.filter(p => p.weight_category === w);
                const full = items.reduce((sum, p) => sum + (Number(p.stock_quantity) || 0), 0);
                const empty = items.reduce((sum, p) => sum + (Number(p.empty_quantity) || 0), 0);
                return { w, full, empty, total: full + empty };
            });

            document.getElementById('summary-table-body').innerHTML = summary.map(s => `
                <tr><td>${s.w}</td><td>${s.full}</td><td>${s.empty}</td><td>${s.total}</td></tr>
            `).join('');

            new Chart(document.getElementById('weightChart'), {
                type: 'doughnut',
                data: {
                    labels: weights,
                    datasets: [{ data: summary.map(s => s.full), backgroundColor: ['#6366f1', '#10b981', '#f59e0b'], borderWidth: 0 }]
                },
                options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });
        }

        init();
    </script>
</body>
</html>
